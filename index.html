<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spyfall Multiplayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
            touch-action: manipulation; /* Prevents double-tap zoom on mobile */
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease;
        }
        .btn {
            display: inline-block;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            border: 1px solid transparent;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            user-select: none;
        }
        .btn-primary {
            color: #fff;
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .btn-primary:hover {
            background-color: #4338ca;
            border-color: #3730a3;
        }
        .btn-secondary {
            color: #fff;
            background-color: #6b7280;
            border-color: #6b7280;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
            border-color: #4b5563;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.4);
        }
        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
        }
        /* Hide screens */
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <!-- Home Screen -->
        <div id="home-screen">
            <h1 class="text-4xl font-bold text-center mb-6 text-indigo-600">Spyfall</h1>
            
            <div class="space-y-6">
                <!-- Section 1: Set Your Name -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">1. ตั้งชื่อของคุณ</h2>
                    <input type="text" id="player-name-input" placeholder="ใส่ชื่อผู้เล่น..." class="input-field">
                    <p id="name-error" class="text-red-500 text-sm mt-2 hidden">กรุณาตั้งชื่อก่อนเข้าร่วมห้อง</p>
                </div>

                <!-- Section 2: Create a Room -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">2. สร้างห้องใหม่</h2>
                    <button id="create-room-btn" class="btn btn-primary w-full">สร้างห้อง</button>
                </div>

                <!-- Section 3: Join a Room -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">3. เข้าร่วมห้อง</h2>
                    <input type="text" id="room-code-input" placeholder="ใส่รหัสห้อง..." class="input-field mb-3 uppercase" maxlength="4">
                    <button id="join-room-btn" class="btn btn-secondary w-full">เข้าร่วมห้อง</button>
                </div>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="hidden card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">ห้อง: <span id="lobby-room-code" class="text-indigo-600 font-mono"></span></h2>
                <button id="copy-code-btn" class="text-sm btn btn-secondary py-1 px-3">คัดลอก</button>
            </div>
            <p class="mb-4 text-gray-600">กำลังรอผู้เล่นอื่น...</p>
            <div id="player-list" class="space-y-2 mb-6">
                <!-- Player list will be generated here -->
            </div>
            <div id="game-settings" class="hidden">
                 <label for="timer-select" class="block text-sm font-medium text-gray-700 mb-2">ตั้งเวลา:</label>
                 <select id="timer-select" class="input-field w-full mb-4">
                    <option value="480">8 นาที (แนะนำ)</option>
                    <option value="420">7 นาที</option>
                    <option value="360">6 นาที</option>
                    <option value="300">5 นาที</option>
                 </select>
            </div>
            <button id="start-game-btn" class="btn btn-primary w-full hidden">เริ่มเกม</button>
            <p id="start-game-error" class="text-center text-red-500 mt-2 text-sm"></p>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden card">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-3xl font-bold text-indigo-600">Spyfall</h2>
                <div id="timer" class="text-2xl font-mono bg-gray-200 px-3 py-1 rounded-md">08:00</div>
            </div>
            <div id="game-content" class="text-center p-6 bg-gray-50 rounded-lg my-4 min-h-[150px] flex flex-col justify-center items-center">
                <p class="text-lg mb-2">สถานที่:</p>
                <h3 id="location-display" class="text-2xl font-bold">???</h3>
                <p class="text-sm mt-4 text-gray-500">บทบาท:</p>
                <p id="role-display" class="text-lg font-semibold">???</p>
            </div>
            <div id="spy-actions" class="hidden">
                <button id="show-locations-btn" class="btn btn-secondary w-full">ดูรายชื่อสถานที่ทั้งหมด</button>
            </div>
        </div>

        <!-- Locations Modal -->
        <div id="locations-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="card w-full max-w-lg max-h-[80vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4">รายชื่อสถานที่ทั้งหมด</h3>
                <div id="locations-list" class="location-grid text-sm">
                    <!-- Location list will be generated here -->
                </div>
                <button id="close-locations-btn" class="btn btn-primary w-full mt-6">ปิด</button>
            </div>
        </div>

        <!-- End Game Modal -->
         <div id="end-game-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="card text-center w-full max-w-md">
                <h3 class="text-2xl font-bold mb-4">เฉลย</h3>
                <p class="text-lg mb-2">สถานที่คือ:</p>
                <p id="end-location" class="text-xl font-semibold text-indigo-600 mb-4"></p>
                <p class="text-lg mb-2">สายลับคือ:</p>
                <p id="end-spy" class="text-xl font-semibold text-red-500 mb-6"></p>
                <button id="play-again-btn" class="btn btn-primary w-full">เล่นอีกครั้ง</button>
            </div>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // Screen elements
        const homeScreen = document.getElementById('home-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');

        // Home screen elements
        const playerNameInput = document.getElementById('player-name-input');
        const nameError = document.getElementById('name-error');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomCodeInput = document.getElementById('room-code-input');
        const joinRoomBtn = document.getElementById('join-room-btn');
        
        // Lobby elements
        const lobbyRoomCode = document.getElementById('lobby-room-code');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const playerList = document.getElementById('player-list');
        const startGameBtn = document.getElementById('start-game-btn');
        const startGameError = document.getElementById('start-game-error');
        const gameSettings = document.getElementById('game-settings');
        const timerSelect = document.getElementById('timer-select');

        // Game elements
        const timerDisplay = document.getElementById('timer');
        const locationDisplay = document.getElementById('location-display');
        const roleDisplay = document.getElementById('role-display');
        const spyActions = document.getElementById('spy-actions');
        const showLocationsBtn = document.getElementById('show-locations-btn');

        // Modals
        const locationsModal = document.getElementById('locations-modal');
        const locationsList = document.getElementById('locations-list');
        const closeLocationsBtn = document.getElementById('close-locations-btn');
        const endGameModal = document.getElementById('end-game-modal');
        const endLocation = document.getElementById('end-location');
        const endSpy = document.getElementById('end-spy');
        const playAgainBtn = document.getElementById('play-again-btn');

        let countdown;
        let isHost = false;
        
        // --- Event Listeners ---
        
        createRoomBtn.addEventListener('click', () => {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                nameError.classList.remove('hidden');
                return;
            }
            nameError.classList.add('hidden');
            socket.emit('createRoom', { playerName });
            isHost = true;
        });

        joinRoomBtn.addEventListener('click', () => {
            const playerName = playerNameInput.value.trim();
            const roomCode = roomCodeInput.value.trim().toUpperCase();
            if (!playerName) {
                nameError.classList.remove('hidden');
                return;
            }
            if (!roomCode) return;
            nameError.classList.add('hidden');
            socket.emit('joinRoom', { playerName, roomCode });
        });
        
        copyCodeBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(lobbyRoomCode.textContent)
                .then(() => {
                    copyCodeBtn.textContent = 'คัดลอกแล้ว!';
                    setTimeout(() => { copyCodeBtn.textContent = 'คัดลอก'; }, 2000);
                });
        });

        startGameBtn.addEventListener('click', () => {
            const selectedTime = timerSelect.value;
            socket.emit('startGame', { time: selectedTime });
        });
        
        showLocationsBtn.addEventListener('click', () => locationsModal.classList.remove('hidden'));
        closeLocationsBtn.addEventListener('click', () => locationsModal.classList.add('hidden'));

        playAgainBtn.addEventListener('click', () => {
            endGameModal.classList.add('hidden');
            gameScreen.classList.add('hidden');
            lobbyScreen.classList.remove('hidden');
        });

        // --- Socket.IO Handlers ---

        socket.on('roomCreated', (data) => {
            showScreen('lobby');
            lobbyRoomCode.textContent = data.roomCode;
        });

        socket.on('joinSuccess', (data) => {
            showScreen('lobby');
            lobbyRoomCode.textContent = data.roomCode;
        });
        
        socket.on('error', (message) => {
            alert(message);
        });

        socket.on('updatePlayerList', (data) => {
            const players = Array.isArray(data) ? data : data.players;
            if (!players) {
                console.error("Invalid player list data received", data);
                return;
            }

            playerList.innerHTML = '';
            players.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center bg-gray-100 p-2 rounded';
                
                const crown = player.isHost ? '👑' : '';
                playerDiv.innerHTML = `<span class="font-semibold">${crown} ${player.name}</span>`;

                if (isHost && player.id !== socket.id) {
                     const kickButton = document.createElement('button');
                     kickButton.textContent = 'เตะ';
                     kickButton.className = 'ml-auto text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600';
                     kickButton.onclick = () => {
                         socket.emit('kickPlayer', player.id);
                     };
                     playerDiv.appendChild(kickButton);
                }

                playerList.appendChild(playerDiv);
            });
            
            // Show start button if host and enough players
            if (isHost) {
                gameSettings.classList.remove('hidden');
                startGameBtn.classList.remove('hidden');
                if (players.length >= 3) {
                    startGameBtn.disabled = false;
                    startGameError.textContent = '';
                } else {
                    startGameBtn.disabled = true;
                    startGameError.textContent = 'ต้องมีผู้เล่นอย่างน้อย 3 คน';
                }
            }
        });

        socket.on('gameStarted', ({ location, role }) => {
            showScreen('game');
            locationDisplay.textContent = location;
            roleDisplay.textContent = role;
            if (role === 'สายลับ') {
                spyActions.classList.remove('hidden');
            } else {
                spyActions.classList.add('hidden');
            }
            endGameModal.classList.add('hidden');
        });

        socket.on('allLocations', (allLocations) => {
            locationsList.innerHTML = '';
            allLocations.forEach(loc => {
                const p = document.createElement('p');
                p.textContent = loc;
                p.className = 'p-2 bg-gray-100 rounded';
                locationsList.appendChild(p);
            });
        });

        socket.on('timerUpdate', (timeLeft) => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        });
        
        socket.on('gameOver', ({ location, spyName }) => {
            endGameModal.classList.remove('hidden');
            endLocation.textContent = location;
            endSpy.textContent = spyName;
        });

        socket.on('kicked', () => {
            alert('คุณถูกเตะออกจากห้อง');
            window.location.reload();
        });


        // --- Utility Functions ---

        function showScreen(screenName) {
            homeScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');

            if (screenName === 'home') homeScreen.classList.remove('hidden');
            if (screenName === 'lobby') lobbyScreen.classList.remove('hidden');
            if (screenName === 'game') gameScreen.classList.remove('hidden');
        }

    </script>
</body>
</html>

