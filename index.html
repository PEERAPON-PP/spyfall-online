<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Spyfall</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div id="home-screen">
    <h1 class="text-3xl font-bold text-indigo-600 mb-4">Spyfall</h1>
    <input id="player-name-input" placeholder="ชื่อผู้เล่น" class="border p-2 mb-2 w-full">
    <button id="create-room-btn" class="btn btn-primary w-full mb-2 bg-indigo-500 text-white p-2 rounded">สร้างห้อง</button>
    <input id="room-code-input" placeholder="รหัสห้อง" maxlength="4" class="border p-2 mb-2 w-full">
    <button id="join-room-btn" class="btn btn-secondary w-full bg-gray-600 text-white p-2 rounded">เข้าร่วมห้อง</button>
  </div>

  <div id="lobby-screen" class="hidden">
    <h2 class="text-xl">ห้อง: <span id="lobby-room-code"></span></h2>
    <div id="player-list" class="my-2"></div>
    <div id="game-settings" class="hidden">
      <select id="timer-select"><option value="300">5 นาที</option><option value="600">10 นาที</option></select>
      <select id="rounds-select"><option value="3">3</option><option value="5" selected>5</option></select>
      <select id="theme-select"><option value="all">ทั้งหมด</option><option value="default">ทั่วไป</option><option value="fairytale">นิทาน</option></select>
    </div>
    <button id="start-game-btn" class="btn btn-primary hidden bg-indigo-500 text-white p-2 rounded w-full mt-2">เริ่มเกม</button>
  </div>

  <div id="game-screen" class="hidden">
    <div>เวลา: <span id="timer">00:00</span></div>
    <div>รอบ <span id="current-round"></span>/<span id="total-rounds"></span></div>
    <div>สถานที่: <span id="location-display">???</span></div>
    <div>บทบาท: <span id="role-display">???</span></div>
    <div id="spy-actions" class="hidden"><button id="show-locations-btn">ดูสถานที่</button></div>
    <button id="host-end-round-btn" class="hidden bg-gray-600 text-white p-2 rounded w-full mt-2">บังคับโหวต</button>
    <div id="in-game-scoreboard"></div>
  </div>

  <!-- Voting Modal -->
  <div id="voting-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded w-80">
      <div id="vote-reason" class="mb-2 font-bold"></div>
      <div id="vote-player-buttons"></div>
      <button id="abstain-vote-btn" class="bg-gray-500 text-white p-2 rounded w-full mt-2">งดออกเสียง</button>
      <div>เหลือเวลา <span id="vote-timer">120</span> วิ</div>
    </div>
  </div>

  <!-- Spy Guess Modal -->
  <div id="spy-guess-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded w-80">
      <div id="spy-guess-taunt" class="text-red-500"></div>
      <select id="spy-location-guess" class="w-full border p-2 mb-2"></select>
      <button id="confirm-spy-guess-btn" class="bg-indigo-500 text-white p-2 rounded w-full">ยืนยัน</button>
    </div>
  </div>

  <!-- End Round -->
  <div id="end-round-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded w-80">
      <div>สถานที่: <span id="end-location"></span></div>
      <div>สายลับ: <span id="end-spy"></span></div>
      <pre id="round-result-text"></pre>
      <button id="next-round-btn" class="bg-indigo-500 text-white p-2 rounded w-full mt-2">รอบต่อไป</button>
      <button id="back-to-lobby-btn" class="bg-gray-600 text-white p-2 rounded w-full mt-2">กลับล็อบบี้</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const $=id=>document.getElementById(id);
    const socket=io();
    let playerToken=localStorage.getItem('playerToken')||crypto.randomUUID();
    localStorage.setItem('playerToken',playerToken);
    let isHost=false,voteTimerInterval;

    const screens={home:$('home-screen'),lobby:$('lobby-screen'),game:$('game-screen')};
    const modals={vote:$('voting-modal'),spy:$('spy-guess-modal'),end:$('end-round-modal')};
    const showScreen=name=>{Object.values(screens).forEach(s=>s.classList.add('hidden'));screens[name].classList.remove('hidden');}
    const showModal=name=>{Object.values(modals).forEach(m=>m.classList.add('hidden'));if(name)modals[name].classList.remove('hidden');}
    const updateScoreboard=(players,c)=>{c.innerHTML='';players.forEach(p=>{const d=document.createElement('div');d.textContent=`${p.name} - ${p.score}`;c.appendChild(d);});}

    $('create-room-btn').onclick=()=>{const n=$('player-name-input').value.trim();if(!n)return;socket.emit('createRoom',{playerName:n,playerToken});};
    $('join-room-btn').onclick=()=>{const n=$('player-name-input').value.trim();const c=$('room-code-input').value.trim().toUpperCase();if(!n||!c)return;socket.emit('joinRoom',{playerName:n,roomCode:c,playerToken});};
    $('start-game-btn').onclick=()=>{socket.emit('startGame',{time:$('timer-select').value,rounds:$('rounds-select').value,theme:$('theme-select').value});};
    $('host-end-round-btn').onclick=()=>socket.emit('hostEndRound');
    $('confirm-spy-guess-btn').onclick=()=>{socket.emit('spyGuessLocation',$('spy-location-guess').value);showModal();};
    $('abstain-vote-btn').onclick=()=>submitVote(null);

    socket.on('roomCreated',({roomCode})=>{showScreen('lobby');$('lobby-room-code').textContent=roomCode;});
    socket.on('joinSuccess',({roomCode})=>{showScreen('lobby');$('lobby-room-code').textContent=roomCode;});
    socket.on('updatePlayerList',players=>{const me=players.find(p=>p.token===playerToken);isHost=me?.isHost;updateScoreboard(players,$('player-list'));if(isHost){$('game-settings').classList.remove('hidden');$('start-game-btn').classList.remove('hidden');}else{$('game-settings').classList.add('hidden');$('start-game-btn').classList.add('hidden');}});
    socket.on('gameStarted',({location,role,round,totalRounds,isHost:host,players})=>{showScreen('game');$('location-display').textContent=location;$('role-display').textContent=role;$('current-round').textContent=round;$('total-rounds').textContent=totalRounds;$('spy-actions').classList.toggle('hidden',role!=='สายลับ');$('host-end-round-btn').classList.toggle('hidden',!host);updateScoreboard(players,$('in-game-scoreboard'));});
    socket.on('timerUpdate',({timeLeft,players})=>{$('timer').textContent=`${String(Math.floor(timeLeft/60)).padStart(2,'0')}:${String(timeLeft%60).padStart(2,'0')}`;updateScoreboard(players,$('in-game-scoreboard'));});
    socket.on('startVote',({players,reason})=>{showModal('vote');$('vote-reason').textContent=reason;$('vote-player-buttons').innerHTML='';const meId=socket.playerData?.id;players.forEach(p=>{if(p.id===meId)return;const b=document.createElement('button');b.textContent=p.name;b.className='btn btn-primary w-full mb-2 vote-btn';b.onclick=()=>submitVote(p.id,b);$('vote-player-buttons').appendChild(b);});let t=120;$('vote-timer').textContent=t;clearInterval(voteTimerInterval);voteTimerInterval=setInterval(()=>{t--;$('vote-timer').textContent=t;if(t<=0)clearInterval(voteTimerInterval);},1000);});
    socket.on('spyGuessPhase',({locations,taunt})=>{showModal('spy');$('spy-guess-taunt').textContent=taunt;$('spy-location-guess').innerHTML='';locations.forEach(l=>{const o=document.createElement('option');o.value=l;o.textContent=l;$('spy-location-guess').appendChild(o);});});
    socket.on('spyIsGuessing',({spyName})=>{showModal();alert(`กำลังรอ ${spyName} เลือกสถานที่`);});
    socket.on('roundOver',({location,spyName,resultText,isFinalRound,players})=>{showModal('end');$('end-location').textContent=location;$('end-spy').textContent=spyName;$('round-result-text').textContent=resultText;updateScoreboard(players,$('in-game-scoreboard'));});
    function submitVote(id,btn){socket.emit('submitVote',id);document.querySelectorAll('.vote-btn').forEach(b=>b.disabled=true);$('abstain-vote-btn').disabled=true;if(btn)btn.textContent+=' ✅';}
  </script>
</body>
</html>
